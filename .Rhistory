knitr::opts_chunk$set(echo = TRUE)
summary(datos$)
summary(datos)
summary(datos)
library(eurostat)
datos = get_eurostat("env_ac_aigg_q")
summary(datos)
summary(datos$nace_r2)
head(datos$unit)
View(datos)
summary(datos)
head(datos$unit)
summary(datos$unit)
str(datos$unit)
summary(datos$nace_r2)
view(datos)
View(datos)
datos$unit
unique(datos$unit)
View(datosTT)
datosTT <- datos %>%
filter(unit=="THS_T") %>%
filter(geo!="EU27_2020")
library(dplyr)
datosTT <- datos %>%
filter(unit=="THS_T") %>%
filter(geo!="EU27_2020")
View(datosTT)
library(sf)
library(tmap)
EU_MAP<-st_read("C:/EMILIO/UNIVERSIDAD/2022-2023/segundo cuatrimestre/TFG/NUTS_RG_60M_2021_3035.shp")
summary(EU_MAP)
summary(EU_MAP$LEVL_CODE)
st_crs(EU_MAP)
tm_shape(EU_MAP)+
tm_borders()
EU_MAP <- EU_MAP %>%
filter(LEVL_CODE==0)
tm_shape(EU_MAP)+
tm_borders()
EU_mapa<-dplyr::left_join(EU_MAP, datosTT, by=c("NUTS_ID"="geo"))
EU_mapa_THAB<-dplyr::left_join(EU_MAP, datosTHAB, by=c("NUTS_ID"="geo"))
EU_mapa<-dplyr::left_join(EU_MAP, datosTT, by=c("NUTS_ID"="geo"))
EU_mapa <- EU_mapa %>%
filter(values != "NA")
EU_mapa2207 <- EU_mapa %>%
filter(TIME_PERIOD=="2024-07-01")
tm_shape(EU_mapa2207,)+
tm_fill(palette ="Blues",col = "values",style = "quantile")
tmap_mode("view")
bbox_eu <- st_bbox(c(xmin = -20, ymin = 30, xmax = 40, ymax = 67), crs = 4326)
tm_shape(EU_mapa2207, bbox = bbox_eu) +
tm_polygons(
fill = "values",
fill.scale = tm_scale(
breaks = c(0, 14000, 36000, 68000, 92000, 280000),
values = "brewer.yl_or_rd",  # antes: "YlOrRd"
labels = c("≤ 14k", "14k – 36k", "36k – 68k", "68k – 92k", "> 92k")
),
fill.legend = tm_legend(title = "Toneladas C02 expulsadas", outside = TRUE)
) +
tm_view(view.zoom = 5) +
tm_layout(frame = FALSE) +
tm_title("Emisiones de Gases de Efecto Invernadero en Europa")
EU_mapa_media <- EU_mapa %>%
group_by(NUTS_NAME) %>%        # agrupa por país (ajusta el nombre si es otro, ej. "name")
summarise(media_value = mean(values, na.rm = TRUE)) %>%
ungroup()
#ahora visualizamos la importancia de cada país.
tmap_mode("view")
bbox_eu <- st_bbox(c(xmin = -20, ymin = 30, xmax = 40, ymax = 67), crs = 4326)
tm_shape(EU_mapa_media, bbox = bbox_eu) +
tm_polygons(
fill = "media_value",
fill.scale = tm_scale(
breaks = c(0, 14000, 36000, 68000, 92000, 150000, 280000),
values = "brewer.yl_or_rd",  # antes: "YlOrRd"
labels = c("≤ 14k", "14k – 36k", "36k – 68k", "68k – 92k", "92k - 150k",">150k")
),
fill.legend = tm_legend(title = "Toneladas GEI expulsadas", outside = TRUE)
) +
tm_view(view.zoom = 5) +
tm_layout(frame = FALSE) +
tm_title("Emisiones de Gases de Efecto Invernadero en media en Europa 2008-2024")
EU_mapa<-dplyr::left_join(EU_MAP, datosTT, by=c("NUTS_ID"="geo"))
EU_mapa <- EU_mapa %>%
filter(values != "NA")
EU_mapa2207 <- EU_mapa %>%
filter(TIME_PERIOD=="2024-07-01")
tm_shape(EU_mapa2207,)+
tm_fill(palette ="Blues",col = "values",style = "quantile")
View(datosTT)
View(EU_MAP)
EU_mapa2207 <- EU_mapa %>%
filter(TIME_PERIOD=="2024-07-01")
tm_shape(EU_mapa2207,)+
tm_fill(palette ="Blues",col = "values",style = "quantile")
tmap_mode("view")
bbox_eu <- st_bbox(c(xmin = -20, ymin = 30, xmax = 40, ymax = 67), crs = 4326)
tm_shape(EU_mapa2207, bbox = bbox_eu) +
tm_polygons(
fill = "values",
fill.scale = tm_scale(
breaks = c(0, 14000, 36000, 68000, 92000, 280000),
values = "brewer.yl_or_rd",  # antes: "YlOrRd"
labels = c("≤ 14k", "14k – 36k", "36k – 68k", "68k – 92k", "> 92k")
),
fill.legend = tm_legend(title = "Toneladas C02 expulsadas", outside = TRUE)
) +
tm_view(view.zoom = 5) +
tm_layout(frame = FALSE) +
tm_title("Emisiones de Gases de Efecto Invernadero en Europa")
library(dplyr)
library(sf)
library(tmap)
# 1) Filtrado temporal con TIME_PERIOD
EU_mapacovidxHAB <- EU_mapa_THAB %>%
mutate(TIME_PERIOD = as.Date(TIME_PERIOD)) %>%
filter(TIME_PERIOD >= as.Date("2019-07-01"),
TIME_PERIOD <= as.Date("2020-10-01"))
EU_mapa_media <- EU_mapa %>%
group_by(NUTS_NAME) %>%        # agrupa por país (ajusta el nombre si es otro, ej. "name")
summarise(media_value = mean(values, na.rm = TRUE)) %>%
ungroup()
#ahora visualizamos la importancia de cada país.
tmap_mode("view")
bbox_eu <- st_bbox(c(xmin = -20, ymin = 30, xmax = 40, ymax = 67), crs = 4326)
tm_shape(EU_mapa_media, bbox = bbox_eu) +
tm_polygons(
fill = "media_value",
fill.scale = tm_scale(
breaks = c(0, 14000, 36000, 68000, 92000, 150000, 280000),
values = "brewer.yl_or_rd",  # antes: "YlOrRd"
labels = c("≤ 14k", "14k – 36k", "36k – 68k", "68k – 92k", "92k - 150k",">150k")
),
fill.legend = tm_legend(title = "Toneladas GEI expulsadas", outside = TRUE)
) +
tm_view(view.zoom = 5) +
tm_layout(frame = FALSE) +
tm_title("Emisiones de Gases de Efecto Invernadero en media en Europa 2008-2024")
EU_mapacovidxHAB <- EU_mapa_THAB %>%
mutate(TIME_PERIOD = as.Date(TIME_PERIOD)) %>%
filter(TIME_PERIOD >= as.Date("2019-07-01"),
TIME_PERIOD <= as.Date("2020-10-01"))
EU_mapa <- EU_mapa %>%
filter(values != "NA")
tm_shape(EU_mapa2207,)+
tm_fill(palette ="Blues",col = "values",style = "quantile")
tm_shape(EU_mapa_media, bbox = bbox_eu) +
tm_polygons(
fill = "media_value",
fill.scale = tm_scale(
breaks = c(0, 14000, 36000, 68000, 92000, 150000, 280000),
values = "brewer.yl_or_rd",  # antes: "YlOrRd"
labels = c("≤ 14k", "14k – 36k", "36k – 68k", "68k – 92k", "92k - 150k",">150k")
),
fill.legend = tm_legend(title = "Toneladas GEI expulsadas", outside = TRUE)
) +
tm_view(view.zoom = 5) +
tm_layout(frame = FALSE) +
tm_title("Emisiones de Gases de Efecto Invernadero en media en Europa 2008-2024")
EU_mapa_media <- EU_mapa %>%
group_by(NUTS_NAME) %>%        # agrupa por país (ajusta el nombre si es otro, ej. "name")
summarise(media_value = mean(values, na.rm = TRUE)) %>%
ungroup()
#ahora visualizamos la importancia de cada país.
tmap_mode("view")
bbox_eu <- st_bbox(c(xmin = -20, ymin = 30, xmax = 40, ymax = 67), crs = 4326)
tm_shape(EU_mapa_media, bbox = bbox_eu) +
tm_polygons(
fill = "media_value",
fill.scale = tm_scale(
breaks = c(0, 14000, 36000, 68000, 92000, 150000, 280000),
values = "brewer.yl_or_rd",  # antes: "YlOrRd"
labels = c("≤ 14k", "14k – 36k", "36k – 68k", "68k – 92k", "92k - 150k",">150k")
),
fill.legend = tm_legend(title = "Toneladas GEI expulsadas", outside = TRUE)
) +
tm_view(view.zoom = 5) +
tm_layout(frame = FALSE) +
tm_title("Emisiones de Gases de Efecto Invernadero en media en Europa 2008-2024")
EU_mapa_media <- EU_mapa %>%
group_by(NUTS_NAME) %>%        # agrupa por país (ajusta el nombre si es otro, ej. "name")
summarise(media_value = mean(values, na.rm = TRUE)) %>%
ungroup()
#ahora visualizamos la importancia de cada país.
tmap_mode("view")
bbox_eu <- st_bbox(c(xmin = -20, ymin = 30, xmax = 40, ymax = 67), crs = 4326)
tm_shape(EU_mapa_media, bbox = bbox_eu) +
tm_polygons(
fill = "media_value",
fill.scale = tm_scale(
breaks = c(0, 14000, 36000, 68000, 92000, 150000, 280000),
values = "brewer.yl_or_rd",  # antes: "YlOrRd"
labels = c("≤ 14k", "14k – 36k", "36k – 68k", "68k – 92k", "92k - 150k",">150k")
),
fill.legend = tm_legend(title = "Toneladas GEI expulsadas", outside = TRUE)
) +
tm_view(view.zoom = 5) +
tm_layout(frame = FALSE) +
tm_title("Emisiones de Gases de Efecto Invernadero en media en Europa 2008-2024")
library(dplyr)
library(sf)
library(ggplot2)
library(gganimate)
# 1) Fechas y proyección a WGS84 para poder usar límites en lon/lat
EU_mapacovidxHAB <- EU_mapa_THAB %>%
mutate(TIME_PERIOD = as.Date(TIME_PERIOD)) %>%
filter(TIME_PERIOD >= as.Date("2019-07-01"),
TIME_PERIOD <= as.Date("2024-07-01")) %>%
st_transform(4326)   # <- importante para que el zoom en grados funcione
knitr::opts_chunk$set(echo = TRUE)
library(eurostat)
datos = get_eurostat("env_ac_aigg_q")
View(datos)
unique(datos$unit)
knitr::opts_chunk$set(echo = TRUE)
library(eurostat)
datos = get_eurostat("env_ac_aigg_q")
unique(datos$unit)
library(dplyr)
datosTT <- datos %>%
filter(unit=="THS_T") %>%
filter(geo!="EU27_2020")
library(sf)
library(tmap)
EU_MAP<-st_read("C:/EMILIO/UNIVERSIDAD/2022-2023/segundo cuatrimestre/TFG/NUTS_RG_60M_2021_3035.shp")
summary(EU_MAP)
summary(EU_MAP$LEVL_CODE)
st_crs(EU_MAP)
tm_shape(EU_MAP)+
tm_borders()
EU_MAP <- EU_MAP %>%
filter(LEVL_CODE==0)
tm_shape(EU_MAP)+
tm_borders()
EU_mapa<-dplyr::left_join(EU_MAP, datosTT, by=c("NUTS_ID"="geo"))
EU_mapa <- EU_mapa %>%
filter(values != "NA")
EU_mapa2207 <- EU_mapa %>%
filter(TIME_PERIOD=="2024-07-01")
tm_shape(EU_mapa2207,)+
tm_fill(palette ="Blues",col = "values",style = "quantile")
EU_mapa_media <- EU_mapa %>%
group_by(NUTS_NAME) %>%
summarise(media_value = mean(values, na.rm = TRUE)) %>%
ungroup()
#ahora visualizamos la importancia de cada país.
tmap_mode("view")
bbox_eu <- st_bbox(c(xmin = -20, ymin = 30, xmax = 40, ymax = 67), crs = 4326)
tm_shape(EU_mapa_media, bbox = bbox_eu) +
tm_polygons(
fill = "media_value",
fill.scale = tm_scale(
breaks = c(0, 14000, 36000, 68000, 92000, 150000, 280000),
values = "brewer.yl_or_rd",  # antes: "YlOrRd"
labels = c("≤ 14k", "14k – 36k", "36k – 68k", "68k – 92k", "92k - 150k",">150k")
),
fill.legend = tm_legend(title = "Toneladas GEI expulsadas", outside = TRUE)
) +
tm_view(view.zoom = 5) +
tm_layout(frame = FALSE) +
tm_title("Emisiones de Gases de Efecto Invernadero en media en Europa 2008-2024")
library(dplyr)
library(forecast)
library(ggplot2)
library(stats)
datosEU_THS_T <- datos %>%
filter(unit=="THS_T") %>%
filter(geo=="EU27_2020") %>%
filter(nace_r2=="TOTAL_HH") %>%
arrange(TIME_PERIOD)
datosEU_THS_T.ts <- ts(datosEU_THS_T$values,end=c(2025,1),frequency =4)
ggtsdisplay(datosEU_THS_T.ts,main="Expulsion de gases de efecto invernadero en EUROPA",xlab="AÑO",ylab="MIlies de toneladas")
fitTHS <- decompose(datosEU_THS_T.ts, type='additive')
autoplot(fitTHS)+
labs(title = "Expulsion de gases de efecto invernadero en Europa",
x = "Tiempo",
y = "Miles de toneladas",
colour = "Gears")+
theme_bw()
autoplot(datosEU_THS_T.ts, series="Serie Temporal") +
autolayer(trendcycle(fitTHS), series="Tendencia") +
labs(title = "Expulsión de gases de efecto invernadero en Europa",
x = "Años",
y = "Miles de toneladas"
) +
theme_bw()
ggseasonplot(datosEU_THS_T.ts)
summary(datosEU_THS_T$values)
# Convertir a millones de toneladas para visualizar mejor
datosEU_THS_T_mill <- datosEU_THS_T.ts / 1e6
library(dygraphs)
dygraph(datosEU_THS_T_mill,
main ="Expulsión de gases de efecto invernadero por Europa",
xlab = "Años",
ylab = "Millones de toneladas")
nsdiffs(datosEU_THS_T.ts)#estacionales
plot(decompose(diff.datosEU_THS_T.ts))
library(forecast)
diff.datosEU_THS_T.ts<-diff(datosEU_THS_T.ts)
plot(datosEU_THS_T.ts,main="serie sin diferenciar",col="purple")
plot(diff.datosEU_THS_T.ts,main="serie diferenciada regularmente",col="purple")
plot(decompose(diff.datosEU_THS_T.ts))
diff.datosEU_THS_T.ts.4<-diff(diff.datosEU_THS_T.ts, lag = 4)
plot(datosEU_THS_T.ts,main="serie sin diferenciar",col="purple")
plot(diff.datosEU_THS_T.ts.4,main="serie con una diferencia regular y otra estacional",col="purple")
library(tseries)
adf<-adf.test(diff.datosEU_THS_T.ts.4)
adf$p.value
Acf(diff.datosEU_THS_T.ts.4)
Pacf(diff.datosEU_THS_T.ts.4)
ggtsdisplay(diff.datosEU_THS_T.ts.4)
arima9<- Arima(datosEU_THS_T.ts, order=c(0,1,0), seasonal=list(order=c(0,1,1),period=4))
BIC(arima1,arima2,arima3,arima4,arima5,arima6,arima7,arima8,arima9)
library(forecast)
arima1<- Arima(datosEU_THS_T.ts, order=c(0,1,2), seasonal=list(order=c(0,1,1),period=4))
arima2<- Arima(datosEU_THS_T.ts, order=c(1,1,0), seasonal=list(order=c(1,1,1),period=4))
arima3<- Arima(datosEU_THS_T.ts, order=c(1,1,1), seasonal=list(order=c(1,1,0),period=4))
arima4<- Arima(datosEU_THS_T.ts, order=c(1,1,1), seasonal=list(order=c(1,1,1),period=4))
arima5<- Arima(datosEU_THS_T.ts, order=c(1,1,2), seasonal=list(order=c(1,1,1),period=4))
arima6<- Arima(datosEU_THS_T.ts, order=c(0,1,1), seasonal=list(order=c(0,1,1),period=4))
arima7<- Arima(datosEU_THS_T.ts, order=c(1,1,0), seasonal=list(order=c(1,1,0),period=4))
arima8<- Arima(datosEU_THS_T.ts, order=c(1,0,0), seasonal=list(order=c(0,1,1),period=4))
arima9<- Arima(datosEU_THS_T.ts, order=c(0,1,0), seasonal=list(order=c(0,1,1),period=4))
#Para la serie de miles de toneladas
AIC(arima1,arima2,arima3,arima4,arima5,arima6,arima7,arima8,arima9)
BIC(arima1,arima2,arima3,arima4,arima5,arima6,arima7,arima8,arima9)
checkresiduals(arima6, test=FALSE)
checkresiduals(arima6)
Box.test(arima6$residuals, lag = 20, type = "Ljung-Box")
coeftest(arima6) #el parámetro de media movil etsacional sale significativo.
library(lmtest)
coeftest(arima6) #el parámetro de media movil etsacional sale significativo.
checkresiduals(arima9)
library(forecast)
prediccionesTHS<-forecast(arima6, level = c(95), h = 10)
autoplot(prediccionesTHS, main= "Expulsión de gases de efecto invernadero por trimestre en Europa")
library(forecast)
library(dygraphs)
prediccionesTHS <- forecast(arima6, level = 95, h = 10)
dygraphs::dygraph(
cbind(Serie = datosEU_THS_T.ts, Prediccion = prediccionesTHS$mean),
main = "Expulsión de gases de efecto invernadero por trimestre en Europa"
)
library(forecast)
library(dygraphs)
# Escalar a millones de toneladas
serie_mill <- datosEU_THS_T.ts / 1e6
# Forecast y escala
prediccionesTHS <- forecast(arima6, level = 95, h = 10)
pred_mill <- prediccionesTHS$mean / 1e6
dygraph(
cbind(Serie = serie_mill, Predicción = pred_mill),
main = "GEI expulsados por la UE"
) %>%
dySeries("Serie", label = "Histórico", strokeWidth = 2) %>%
dySeries("Predicción", label = "Pronóstico", strokeWidth = 3, strokePattern = "dashed") %>%
dyAxis("y", label = "Millones de toneladas") %>%
dyAxis("x", label = "Año") %>%
dyOptions(
drawGrid = TRUE,
useDataTimezone = FALSE,
fillGraph = FALSE,
strokeWidth = 2,
titleHeight = 40
) %>%
dyLegend(show = "always") %>%
dyHighlight(
highlightCircleSize = 5,
highlightSeriesBackgroundAlpha = 0.25,
hideOnMouseOut = FALSE
) %>%
dyRangeSelector(height = 30)
library(dplyr)
library(ggplot2)
library(zoo)     # para yearqtr
library(scales)  # para etiquetas bonitas
# Escala a millones
serie_mill <- as.numeric(datosEU_THS_T.ts) / 1e6
ti <- as.yearqtr(time(datosEU_THS_T.ts))
df_q <- tibble::tibble(
Year    = as.integer(format(ti, "%Y")),
Quarter = factor(format(ti, "Q%q"), levels = c("Q1","Q2","Q3","Q4")),
Value   = serie_mill
)
ggplot(df_q, aes(x = factor(Year), y = Quarter, fill = Value)) +
geom_tile() +
scale_fill_viridis_c(name = "Mill. t") +
labs(title = "Mapa de calor: emisiones por trimestre y año",
x = "Año", y = "Trimestre") +
theme_minimal(base_size = 12) +
theme(panel.grid = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1))
ggplot(df_q, aes(x = Quarter, y = Value)) +
geom_boxplot(outlier.alpha = 0.3) +
geom_jitter(width = 0.1, alpha = 0.4) +
scale_y_continuous(labels = label_number(big.mark = ".", decimal.mark = ",")) +
labs(title = "Distribución histórica por trimestre",
x = "Trimestre", y = "Millones de toneladas") +
theme_minimal(base_size = 12)
str(ti)
?yearqtr
library(forecast)
library(dplyr)
library(tidyr)
library(zoo)
library(DT)
# --- 1) Serie y forecast en millones ---
serie_mill <- as.numeric(datosEU_THS_T.ts) / 1e6
pred <- forecast(arima6, h = 10)
pred_mill <- as.numeric(pred$mean) / 1e6
# --- 2) Índices de tiempo correctos (trimestral) ---
ti_hist <- as.yearqtr(time(datosEU_THS_T.ts))
ti_pred <- as.yearqtr(time(pred$mean))
df_hist <- tibble(
Year    = as.integer(format(ti_hist, "%Y")),
Quarter = factor(format(ti_hist, "Q%q"), levels = c("Q1","Q2","Q3","Q4")),
Value   = serie_mill,
Pred    = FALSE
)
df_pred <- tibble(
Year    = as.integer(format(ti_pred, "%Y")),
Quarter = factor(format(ti_pred, "Q%q"), levels = c("Q1","Q2","Q3","Q4")),
Value   = pred_mill,
Pred    = TRUE
)
df <- bind_rows(df_hist, df_pred) %>%
arrange(Year, Quarter)
# --- 3) Pasar a formato ancho (años x trimestres) ---
value_wide <- df %>%
select(Year, Quarter, Value) %>%
pivot_wider(names_from = Quarter, values_from = Value) %>%
arrange(Year)
flag_wide <- df %>%
select(Year, Quarter, Pred) %>%
pivot_wider(names_from = Quarter, values_from = Pred) %>%
arrange(Year) %>%
rename(Q1_pred = Q1, Q2_pred = Q2, Q3_pred = Q3, Q4_pred = Q4)
tabla <- value_wide %>%
left_join(flag_wide, by = "Year")
# --- 4) Tabla interactiva con predicciones coloreadas ---
DT::datatable(
tabla,
rownames = FALSE,
caption = "Emisiones por año y trimestre (millones de toneladas). Las celdas coloreadas son predicciones.",
options = list(
pageLength = 50,
dom = "tip",
columnDefs = list(
# Ocultar columnas auxiliares de predicción
list(visible = FALSE,
targets = which(names(tabla) %in% c("Q1_pred","Q2_pred","Q3_pred","Q4_pred")) - 1)
)
)
) %>%
formatRound(c("Q1","Q2","Q3","Q4"), 2) %>%
# Colorear las predicciones usando las columnas *_pred ocultas
formatStyle('Q1', backgroundColor = styleEqual(c(TRUE, FALSE), c("#e3f2fd", "white")),
valueColumns = "Q1_pred") %>%
formatStyle('Q2', backgroundColor = styleEqual(c(TRUE, FALSE), c("#e3f2fd", "white")),
valueColumns = "Q2_pred") %>%
formatStyle('Q3', backgroundColor = styleEqual(c(TRUE, FALSE), c("#e3f2fd", "white")),
valueColumns = "Q3_pred") %>%
formatStyle('Q4', backgroundColor = styleEqual(c(TRUE, FALSE), c("#e3f2fd", "white")),
valueColumns = "Q4_pred")
forecast_arima6 <- forecast(arima6, h = 8)
autoplot(forecast_arima6)
library(eurostat)
datos = get_eurostat("env_ac_aigg_q")
unique(datos$unit)
library(lmtest)
coeftest(arima6) #el parámetro de media movil etsacional sale significativo.
